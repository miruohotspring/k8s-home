apiVersion: batch/v1
kind: CronJob
metadata:
  name: ecr-token-refresh
  namespace: kube-system
spec:
  schedule: "0 */6 * * *" # every 6 hours
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: ecr-token-updater
          restartPolicy: OnFailure
          volumes:
            - name: work
              emptyDir: {}
          initContainers:
            - name: fetch-token
              image: amazon/aws-cli:latest
              env:
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: k8s-image-pull-credentials
                      key: access_key_id
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: k8s-image-pull-credentials
                      key: secret_access_key
                - name: AWS_REGION
                  value: "ap-northeast-1"
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  aws ecr get-login-password --region "${AWS_REGION}" > /work/token
              volumeMounts:
                - name: work
                  mountPath: /work
          containers:
            - name: refresh
              image: bitnami/kubectl:1.30.14
              env:
                - name: ECR_REGISTRY
                  value: "004908959120.dkr.ecr.ap-northeast-1.amazonaws.com"
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  TOKEN="$(cat /work/token)"
                  for NS in default example-dev; do
                    kubectl create secret docker-registry ecr-secret \
                      --docker-server="${ECR_REGISTRY}" \
                      --docker-username=AWS \
                      --docker-password="${TOKEN}" \
                      --namespace="${NS}" \
                      --dry-run=client -o yaml | kubectl apply -f -
                    echo "Updated ecr-secret in ${NS}"
                  done
                  echo "ECR token refresh completed successfully"
              volumeMounts:
                - name: work
                  mountPath: /work

